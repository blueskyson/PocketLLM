# you can delete this line if you want to remove the warning:
# version: "3.8"

services:
  model-downloader:
    image: curlimages/curl:latest
    platform: linux/amd64
    volumes:
      - ./models:/models
    command:
      - sh
      - -c
      - |
          set -e
          mkdir -p /models
          if [ ! -f /models/Phi-3-mini-4k-instruct-q4.gguf ]; then
            echo "Downloading Phi-3 Mini model..."
            curl -L \
              -o /models/Phi-3-mini-4k-instruct-q4.gguf \
              "https://huggingface.co/microsoft/Phi-3-mini-4k-instruct-gguf/resolve/main/Phi-3-mini-4k-instruct-q4.gguf"
            echo "Model download completed!"
          else
            echo "Model already exists, skipping download."
          fi

  llama-cpp-server:
    image: ghcr.io/ggerganov/llama.cpp:server
    platform: linux/amd64
    ports:
      - "8080:8080"
    volumes:
      - ./models:/models
    depends_on:
      model-downloader:
        condition: service_completed_successfully
    command:
      [
        "--model", "/models/Phi-3-mini-4k-instruct-q4.gguf",
        "--host", "0.0.0.0",
        "--port", "8080",
        "--ctx-size", "4096",
        "--threads", "4"
      ]
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8080/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
